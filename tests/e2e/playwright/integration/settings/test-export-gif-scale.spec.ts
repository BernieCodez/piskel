import test, {  expect } from "@playwright/test";
import { openEditor, openExportSettingsPanel, setPiskelFromGrid, setPiskelFromImageSrc } from "../../testutils";
import fs from 'fs/promises';

// Source for a base64 encoded PNG, 20x20, with 400 different colors.
const base64_gif = [
  'data:image/png;base64,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'].join('');

test('Test export png with scaling', async ({ page }) => {
    await openEditor(page);

    await setPiskelFromImageSrc(page, base64_gif);

    await openExportSettingsPanel(page);

    await expect(page.locator('.export-panel-gif')).toBeAttached();
    await page.click('[data-tab-id="gif"]');

    const defaultHeightInputLocator = page.locator('[name="resize-width"]');
    await defaultHeightInputLocator.fill("40")
    await expect(page.locator('[name="resize-width"]')).toHaveValue("40");
    await expect(page.locator('[name="resize-height"]')).toHaveValue("40");
    await expect(page.locator('[name="scale-input"]')).toHaveValue("2");

    const downloadPromise = page.waitForEvent('download');
    await page.click('.gif-download-button');

    const download = await downloadPromise;
    const path = await download.path();
    if (!path) throw new Error('Download path is null');

    const suggestedFilename = await download.suggestedFilename();
    expect(suggestedFilename).toBe("piskel.gif");

    const buffer = await fs.readFile(path);
    const base64 = buffer.toString('base64');
    const expectedBase64 = "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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    expect(base64).toBe(expectedBase64);
});